"use strict";(self.webpackChunkdatadeling=self.webpackChunkdatadeling||[]).push([[6818],{3905:function(e,t,r){r.d(t,{Zo:function(){return k},kt:function(){return u}});var n=r(7294);function a(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function i(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function o(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?i(Object(r),!0).forEach((function(t){a(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):i(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function l(e,t){if(null==e)return{};var r,n,a=function(e,t){if(null==e)return{};var r,n,a={},i=Object.keys(e);for(n=0;n<i.length;n++)r=i[n],t.indexOf(r)>=0||(a[r]=e[r]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)r=i[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(a[r]=e[r])}return a}var p=n.createContext({}),s=function(e){var t=n.useContext(p),r=t;return e&&(r="function"==typeof e?e(t):o(o({},t),e)),r},k=function(e){var t=s(e.components);return n.createElement(p.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},d=n.forwardRef((function(e,t){var r=e.components,a=e.mdxType,i=e.originalType,p=e.parentName,k=l(e,["components","mdxType","originalType","parentName"]),d=s(r),u=a,g=d["".concat(p,".").concat(u)]||d[u]||m[u]||i;return r?n.createElement(g,o(o({ref:t},k),{},{components:r})):n.createElement(g,o({ref:t},k))}));function u(e,t){var r=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var i=r.length,o=new Array(i);o[0]=d;var l={};for(var p in t)hasOwnProperty.call(t,p)&&(l[p]=t[p]);l.originalType=e,l.mdxType="string"==typeof e?e:a,o[1]=l;for(var s=2;s<i;s++)o[s]=r[s];return n.createElement.apply(null,o)}return n.createElement.apply(null,r)}d.displayName="MDXCreateElement"},2002:function(e,t,r){r.r(t),r.d(t,{frontMatter:function(){return l},contentTitle:function(){return p},metadata:function(){return s},toc:function(){return k},default:function(){return d}});var n=r(7462),a=r(3366),i=(r(7294),r(3905)),o=["components"],l={description:"Tekniske detaljer om bruk og oppsett av meldingsk\xf8.\n\n\nTODO: Skriv om fr\xe5 UiO til bruk for UH-sektoren.",title:"Bruk av meldingsk\xf8"},p="Bruk av meldingsk\xf8",s={unversionedId:"datadeling/teknisk-plattform/mq-oppsett",id:"datadeling/teknisk-plattform/mq-oppsett",isDocsHomePage:!1,title:"Bruk av meldingsk\xf8",description:"Tekniske detaljer om bruk og oppsett av meldingsk\xf8.\n\n\nTODO: Skriv om fr\xe5 UiO til bruk for UH-sektoren.",source:"@site/docs/datadeling/teknisk-plattform/mq-oppsett.md",sourceDirName:"datadeling/teknisk-plattform",slug:"/datadeling/teknisk-plattform/mq-oppsett",permalink:"/datadeling-docs-tmp/docs/datadeling/teknisk-plattform/mq-oppsett",editUrl:"https://github.com/jokim/datadeling-docs-tmp/tree/gh-pages/docs/datadeling/teknisk-plattform/mq-oppsett.md",version:"current",frontMatter:{description:"Tekniske detaljer om bruk og oppsett av meldingsk\xf8.\n\n\nTODO: Skriv om fr\xe5 UiO til bruk for UH-sektoren.",title:"Bruk av meldingsk\xf8"},sidebar:"tutorialSidebar",previous:{title:"F\xf8ringer for bruk av teknisk plattform i UH:IntArk",permalink:"/datadeling-docs-tmp/docs/datadeling/teknisk-plattform/krav"},next:{title:"Oversikt over den tekniske plattformen",permalink:"/datadeling-docs-tmp/docs/datadeling/teknisk-plattform/oversikt"}},k=[{value:"Hurtigstart",id:"hurtigstart",children:[]},{value:"K\xf8yrereglar",id:"k\xf8yrereglar",children:[{value:"Vhosts",id:"vhosts",children:[]},{value:"Brukarar",id:"brukarar",children:[]},{value:"Exchange",id:"exchange",children:[]},{value:"K\xf8",id:"k\xf8",children:[]},{value:"Binding",id:"binding",children:[]},{value:"Topic",id:"topic",children:[]}]},{value:"Notifikasjonar",id:"notifikasjonar",children:[]},{value:"Meir info",id:"meir-info",children:[]}],m={toc:k};function d(e){var t=e.components,r=(0,a.Z)(e,o);return(0,i.kt)("wrapper",(0,n.Z)({},m,r,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"bruk-av-meldingsk\xf8"},"Bruk av meldingsk\xf8"),(0,i.kt)("p",null,"Tekniske detaljer om bruk og oppsett av meldingsk\xf8."),(0,i.kt)("p",null,"TODO: Skriv om fr\xe5 UiO til bruk for UH-sektoren."),(0,i.kt)("h2",{id:"hurtigstart"},"Hurtigstart"),(0,i.kt)("p",null,"For dei utolmodige:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Tilgang: Bestill via ",(0,i.kt)("a",{parentName:"li",href:"https://nettskjema.no/a/bestille-meldingsko"},"nettskjema")),(0,i.kt)("li",{parentName:"ul"},"Host: ",(0,i.kt)("a",{parentName:"li",href:"https://mq.uio.no"},(0,i.kt)("strong",{parentName:"a"},"mq.uio.no"))),(0,i.kt)("li",{parentName:"ul"},"St\xf8tta meldingsprotokoll: ",(0,i.kt)("a",{parentName:"li",href:"http://www.amqp.org/specification/0-9-1/amqp-org-download"},"AMQP 0.9.1")," p\xe5 port 5671 (TLS)"),(0,i.kt)("li",{parentName:"ul"},"Koded\xf8mer: ",(0,i.kt)("a",{parentName:"li",href:"/tjenester/it/utvikling/integrasjonsarkitektur/hjelp/kodeeksempler/pika_publisher.py"},"pika","_","publisher.py")," (sende meldingar) og ",(0,i.kt)("a",{parentName:"li",href:"/tjenester/it/utvikling/integrasjonsarkitektur/hjelp/kodeeksempler/pika_consumer.py"},"pika","_","consumer.py")," (motta meldingar)")),(0,i.kt)("h2",{id:"k\xf8yrereglar"},"K\xf8yrereglar"),(0,i.kt)("p",null,"Vidare f\xe5r du info om korleis vi bruker ",(0,i.kt)("a",{parentName:"p",href:"http://www.amqp.org/specification/0-9-1/amqp-org-download"},"AMQP 0.9.1")," p\xe5 UiO. Sj\xe5 ",(0,i.kt)("a",{parentName:"p",href:"http://www.rabbitmq.com/tutorials/amqp-concepts.html"},"RabbitMQ si beskriving av begrepa")," for meir utdjupande informasjon."),(0,i.kt)("h3",{id:"vhosts"},"Vhosts"),(0,i.kt)("p",null,"En ",(0,i.kt)("em",{parentName:"p"},"virtuell host,")," eller ",(0,i.kt)("em",{parentName:"p"},"vhost"),", er RabbitMQ sin m\xe5te \xe5 skilje prosjekt eller tenester fr\xe5 kvarandre. Alle entiteter - k\xf8, binding og exchange - vil ligge i ",(0,i.kt)("em",{parentName:"p"},"\xe9in")," ",(0,i.kt)("em",{parentName:"p"},"vhost"),"."),(0,i.kt)("p",null,"Formatet til ",(0,i.kt)("em",{parentName:"p"},"vhosts")," liknar p\xe5 ein filstruktur:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"\n/no/\\<HOST\\>/\\<PROSJEKT\\>/[TEST|STAGING|PILOT]\n")),(0,i.kt)("p",null,"For UiO bruker vi prim\xe6rt berre ein ",(0,i.kt)("em",{parentName:"p"},"vhost"),":"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"\n/no/uio/integration\n\n")),(0,i.kt)("p",null,"Testing, staging og anna skiljer vi ut i eigne ",(0,i.kt)("em",{parentName:"p"},"vhosts, til d\xf8mes:")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"\n/no/uio/integration/test\n\n")),(0,i.kt)("h3",{id:"brukarar"},"Brukarar"),(0,i.kt)("p",null,"For \xe5 lese og skrive til meldingsk\xf8a, treng du ein ",(0,i.kt)("em",{parentName:"p"},"brukar")," i meldingsk\xf8a med dei rette tilgangane. Vi skiljer mellom brukarar for avsendarar (",(0,i.kt)("em",{parentName:"p"},"publishers"),") og mottakarar (",(0,i.kt)("em",{parentName:"p"},"consumers"),"). Avsendarar skal ikkje ha tilgang til k\xf8er, og mottakarar skal ikkje kunne skrive til ",(0,i.kt)("em",{parentName:"p"},"exchange-"),"entiteter. Mottakarar har tilgang til \xe5 opprette k\xf8er og knytte dei til ",(0,i.kt)("em",{parentName:"p"},"exchange-"),"entiteter."),(0,i.kt)("h3",{id:"exchange"},"Exchange"),(0,i.kt)("p",null,"Ein ",(0,i.kt)("em",{parentName:"p"},"exchange"),' er eit "postkontor" som ein avsendar sender notifikasjonar til. Notifikasjonane distribuerast (router) vidare derfra, til dei forskjellige ',(0,i.kt)("em",{parentName:"p"},"k\xf8ene")," som vil ha den relevante notifkasjonen."),(0,i.kt)("p",null,"P\xe5 UiO bruker vi prim\xe6rt berre ",(0,i.kt)("em",{parentName:"p"},"ein"),' exchange, "',(0,i.kt)("em",{parentName:"p"},"ex","_",'messages"'),", for ",(0,i.kt)("strong",{parentName:"p"},"alle")," avsendarar. Denne ruter notifikasjonar med metoden ",(0,i.kt)("strong",{parentName:"p"},(0,i.kt)("em",{parentName:"strong"},"Topic Exchange")),"."),(0,i.kt)("h3",{id:"k\xf8"},"K\xf8"),(0,i.kt)("p",null,"Ei k\xf8 (",(0,i.kt)("em",{parentName:"p"},"queue)")," er ",(0,i.kt)("em",{parentName:"p"},"\xe9in")," konsument si samling av notifikasjonar, eller kva type notifikasjonar den vil ha (sj\xe5 ",(0,i.kt)("em",{parentName:"p"},"Binding"),").  ",(0,i.kt)("em",{parentName:"p"},"RabbitMQ")," vidaredistribuerer (router) dei notifikasjonane k\xf8a vil ha. Konsumenten abonnerer d\xe5 p\xe5 denne k\xf8a."),(0,i.kt)("p",null,'Navnet til k\xf8ene starter p\xe5 "',(0,i.kt)("em",{parentName:"p"},"q","_",'"'),', og b\xf8r inneholde navnet p\xe5 mottakaren eller tenesten som bruker den. Til d\xf8mes "',(0,i.kt)("em",{parentName:"p"},"q","_","ad","_",'microservice"'),' eller "q',"_",'cerebrum".'),(0,i.kt)("h3",{id:"binding"},"Binding"),(0,i.kt)("p",null,"Kvar k\xf8 settast opp med kva type notifikasjonar den vil ha - k\xf8a m\xe5 vere bunden (bound) til ein ",(0,i.kt)("em",{parentName:"p"},"exchange")," med ein eller fleire n\xf8klar. For ",(0,i.kt)("em",{parentName:"p"},"topic exchange"),', som "',(0,i.kt)("em",{parentName:"p"},"ex","_",'messages"')," er, g\xe5r knyttinga mot ",(0,i.kt)("em",{parentName:"p"},"topic.")),(0,i.kt)("p",null,"Administratorbrukaren i RabbitMQ set opp dette for forh\xe5ndsdefinerte k\xf8er, rett etter at k\xf8a er oppretta. Mottakar kan ogs\xe5 sj\xf8lv definere k\xf8a, men m\xe5 d\xe5 ha lesetilgang til ",(0,i.kt)("em",{parentName:"p"},"ex","_","messages")," og skrivetilgang til k\xf8a den vil binde."),(0,i.kt)("p",null,"Til d\xf8mes kan k\xf8a ",(0,i.kt)("em",{parentName:"p"},"q","_","ad","_","microservice")," binde seg til ",(0,i.kt)("em",{parentName:"p"},"ex","_","messages"),' med n\xf8kkelen "',(0,i.kt)("em",{parentName:"p"},"cerebrum.event.account."),'"',(0,i.kt)("em",{parentName:"p"},". Dette gjer at alle notifikasjonar med topic som starter med "),'"cerebrum.event.account."',(0,i.kt)("em",{parentName:"p"}," vil dukke opp i "),"q","_","ad","_","microservice*."),(0,i.kt)("h3",{id:"topic"},"Topic"),(0,i.kt)("p",null,"N\xe5r ",(0,i.kt)("em",{parentName:"p"},"topic exchange")," brukast for \xe5 distribuere (route) notifikasjonar fr\xe5 ",(0,i.kt)("em",{parentName:"p"},"exchange")," til riktig k\xf8",(0,i.kt)("em",{parentName:"p"},",")," m\xe5 avsendar markere kvar notifikasjon med ein ",(0,i.kt)("em",{parentName:"p"},"message routing key (topic)"),". RabbitMQ vil sj\xe5 p\xe5 ",(0,i.kt)("em",{parentName:"p"},"topic")," og vidaresende (",(0,i.kt)("em",{parentName:"p"},"route"),") notifikasjonen til dei k\xf8ene som har binding mot samme ",(0,i.kt)("em",{parentName:"p"},"topic.")),(0,i.kt)("p",null,"Strukturen til ",(0,i.kt)("em",{parentName:"p"},"message routing key (topic)"),":"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"\n`kilde`.`type`.`objekt`.`hending`\n\n")),(0,i.kt)("p",null,"der:"),(0,i.kt)("p",null,'| kilde: | Namnet til avsendaren, til d\xf8mes "cerebrum" |\n| type: | Typen melding, til d\xf8mes "event" |\n| objekt: | Vanlegvis kva entitetstype notifikasjonen/hendinga gjeld for, til d\xf8mes "account", "person", "group" eller "employee" |\n| hending: | Kva har skjedd, til d\xf8mes "add", "delete" eller "modify" |'),(0,i.kt)("h2",{id:"notifikasjonar"},"Notifikasjonar"),(0,i.kt)("p",null,"Kva finn du av innhald i notifikasjonane? Etter UiO sin integrasjonsarkitektur skal notifikasjonar vere ",(0,i.kt)("strong",{parentName:"p"},"tynne"),", som betyr at dei skal prim\xe6rt brukast til \xe5 informere om at ",(0,i.kt)("strong",{parentName:"p"},"noko")," har skjedd, for ein gitt entitet, men fortel deg ",(0,i.kt)("strong",{parentName:"p"},"ikkje")," meir om entiteten. Dette m\xe5 du f\xe5 ved \xe5 sp\xf8rre kjeldesystemet."),(0,i.kt)("p",null,"Det er opp til kvar teneste \xe5 definere formatet p\xe5 notifikasjonane sine. Dette skal vere dokumentert hos kvart API, p\xe5 ",(0,i.kt)("a",{parentName:"p",href:"https://api.uio.no"},"api.uio.no"),"."),(0,i.kt)("p",null,"Til d\xf8mes bruker Cerebrum og SAPUiO eit notifikasjonssformat som er inspirert av ",(0,i.kt)("a",{parentName:"p",href:"http://www.simplecloud.info/"},"SCIM")," sitt ",(0,i.kt)("a",{parentName:"p",href:"https://tools.ietf.org/html/draft-hunt-idevent-scim-00"},"utkast til standard p\xe5 eit meldingsformat"),", der vi bruker versjonen med minimalt med informasjon. D\xf8me p\xe5 korleis ei melding vil sj\xe5 ut, ",(0,i.kt)("strong",{parentName:"p"},"omtrent"),":"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'\n{\n  // token identifier (unik id for meldingen)\n  "jti": "4d3559ec67504aaba65d40b0363faad8",\n  // endringer\n  "eventUris": [\n    "urn:ietf:params:event:SCIM:create"\n  ],\n  // timestamp\n  "iat": 1458496404,\n  // issuer\n  "iss": "https://cerebrum-uio.uio.no",\n  // audience (spreads/kontekst) - gjer det enklare \xe5 forkaste meldingar du ikkje er interessert i\n  "aud": [\n   "AD\\_account",\n   "exchange\\_acc@uio.no",\n   "LDAP\\_account"\n  ],\n  // URL til entitet (GET)\n **"sub": "https://cerebrum-ws.uio.no/v1/accounts/1234",**\n  // Parametre til event - her: kva attributtar hos objektet som er p\xe5virka - gjer det enklare \xe5 forkaste meldingar du ikkje er interessert i\n  "urn:ietf:params:event:SCIM:create":{\n    "attributes":["id","name","userName","password","emails"],\n  }\n}\n\n')),(0,i.kt)("p",null,"Andre system, som FS og TP brukar, eit format som er avleda fr\xe5 ",(0,i.kt)("a",{parentName:"p",href:"https://jwt.io"},"JWT"),"-standarden. Eit d\xf8me p\xe5 ein notifikasjon fr\xe5 FS om at ein person er oppdatert (routing key er i dette tilfelle ",(0,i.kt)("em",{parentName:"p"},"no.uio.fs.FS-prod.personer.update"),")"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'\n{"sub": "personer/56154",\n "iss": "FS-prod",\n "iat": "1582344412462",\n "operation": "update",\n "jti": "35380ac0-247d-44b3-9be3-2f2dded049ee",\n "person\\_id": "56154"}\n')),(0,i.kt)("p",null,"Det kan og vere lurt \xe5 ta ei avgjersle om korleis du skal referere til ressursar i kjeldesystem. Til d\xf8mes er me bunden til eit spesielt domene i dette tilfellet:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'\n{"sub": "https://api-waygate.uio.no/eksempeltjeneste/5"}\n')),(0,i.kt)("p",null,"Mens f\xf8ljande ikkje er bunden til ei spesifikk maskin:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'\n{"sub": "/5",\n "iss": "eksempeltjeneste"}\n\n')),(0,i.kt)("p",null,"Det same kan du oppn\xe5 med ein meir formalisert URN:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'\n{"sub": "urn:eksempeltjeneste:5"}\n')),(0,i.kt)("p",null,"I dei to siste d\xf8ma har me ikkje inkludert informasjon om ",(0,i.kt)("em",{parentName:"p"},"kor")," ei ressurs er lokalisert. N\xe5r du hentar ressursen m\xe5 du d\xe5 velje \xe5 sl\xe5 opp maskinnavnet. Erfaringsmessig lettar dette arbeidet med \xe5 flytte tenester mellom forskjellige milj\xf8."),(0,i.kt)("p",null,"For nyutvikla system, b\xf8r du vurdera \xe5 bruka standariserte format, til d\xf8mes ",(0,i.kt)("a",{parentName:"p",href:"https://cloudevents.io/"},"CloudEvents"),"."),(0,i.kt)("h2",{id:"meir-info"},"Meir info"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"http://www.rabbitmq.com/"},"RabbitMQ si offisielle side")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"http://www.rabbitmq.com/getstarted.html"},"Tutorials og koded\xf8mer fr\xe5 RabbitMQ")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"http://www.rabbitmq.com/tutorials/amqp-concepts.html"},"RabbitMQ si beskriving av begrepa i AMQP")),(0,i.kt)("li",{parentName:"ul"},"Beskrivelse av meldingsprotokollen ",(0,i.kt)("a",{parentName:"li",href:"http://www.amqp.org/specification/0-9-1/amqp-org-download"},"AMQP 0.9.1")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://tools.ietf.org/html/draft-hunt-idevent-scim-00"},"Meldingsformatet til SCIM"),", som er utgangspunktet for mange av meldingene, som igjen baserer seg p\xe5 ",(0,i.kt)("a",{parentName:"li",href:"https://jwt.io/"},"JWT")," (",(0,i.kt)("a",{parentName:"li",href:"https://tools.ietf.org/html/rfc7519"},"RFC 7519"),")")))}d.isMDXComponent=!0}}]);