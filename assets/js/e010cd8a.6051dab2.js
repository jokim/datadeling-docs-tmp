"use strict";(self.webpackChunkdatadeling=self.webpackChunkdatadeling||[]).push([[2861],{3905:function(e,t,r){r.d(t,{Zo:function(){return p},kt:function(){return u}});var n=r(7294);function a(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function i(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function l(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?i(Object(r),!0).forEach((function(t){a(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):i(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function o(e,t){if(null==e)return{};var r,n,a=function(e,t){if(null==e)return{};var r,n,a={},i=Object.keys(e);for(n=0;n<i.length;n++)r=i[n],t.indexOf(r)>=0||(a[r]=e[r]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)r=i[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(a[r]=e[r])}return a}var s=n.createContext({}),k=function(e){var t=n.useContext(s),r=t;return e&&(r="function"==typeof e?e(t):l(l({},t),e)),r},p=function(e){var t=k(e.components);return n.createElement(s.Provider,{value:t},e.children)},g={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},d=n.forwardRef((function(e,t){var r=e.components,a=e.mdxType,i=e.originalType,s=e.parentName,p=o(e,["components","mdxType","originalType","parentName"]),d=k(r),u=a,m=d["".concat(s,".").concat(u)]||d[u]||g[u]||i;return r?n.createElement(m,l(l({ref:t},p),{},{components:r})):n.createElement(m,l({ref:t},p))}));function u(e,t){var r=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var i=r.length,l=new Array(i);l[0]=d;var o={};for(var s in t)hasOwnProperty.call(t,s)&&(o[s]=t[s]);o.originalType=e,o.mdxType="string"==typeof e?e:a,l[1]=o;for(var k=2;k<i;k++)l[k]=r[k];return n.createElement.apply(null,l)}return n.createElement.apply(null,r)}d.displayName="MDXCreateElement"},1058:function(e,t,r){r.r(t),r.d(t,{frontMatter:function(){return o},contentTitle:function(){return s},metadata:function(){return k},toc:function(){return p},default:function(){return d}});var n=r(7462),a=r(3366),i=(r(7294),r(3905)),l=["components"],o={description:"Hvordan du kan skjule JWT-autentisering i Gravitee, for eksempel for Maskinporten, uten at hver API-eier trenger f\xe5 tilgang til n\xf8kkelen.",title:"Backend-autentisering med JWTs"},s="Backend-autentisering med JWTs",k={unversionedId:"datadeling/veiledere/api-manager/jwt-mot-backend",id:"datadeling/veiledere/api-manager/jwt-mot-backend",isDocsHomePage:!1,title:"Backend-autentisering med JWTs",description:"Hvordan du kan skjule JWT-autentisering i Gravitee, for eksempel for Maskinporten, uten at hver API-eier trenger f\xe5 tilgang til n\xf8kkelen.",source:"@site/docs/datadeling/veiledere/api-manager/jwt-mot-backend.md",sourceDirName:"datadeling/veiledere/api-manager",slug:"/datadeling/veiledere/api-manager/jwt-mot-backend",permalink:"/datadeling-docs-tmp/docs/datadeling/veiledere/api-manager/jwt-mot-backend",editUrl:"https://github.com/jokim/datadeling-docs-tmp/tree/gh-pages/docs/datadeling/veiledere/api-manager/jwt-mot-backend.md",version:"current",frontMatter:{description:"Hvordan du kan skjule JWT-autentisering i Gravitee, for eksempel for Maskinporten, uten at hver API-eier trenger f\xe5 tilgang til n\xf8kkelen.",title:"Backend-autentisering med JWTs"},sidebar:"tutorialSidebar",previous:{title:"Importer API-oppsett fra fil",permalink:"/datadeling-docs-tmp/docs/datadeling/veiledere/api-manager/importer-api"},next:{title:"Legge p\xe5 en enkel policy (IP filter)",permalink:"/datadeling-docs-tmp/docs/datadeling/veiledere/api-manager/legge-pa-enkel-policy"}},p=[{value:"Bakgrunn",id:"bakgrunn",children:[{value:"Lage JWT i gravitee",id:"lage-jwt-i-gravitee",children:[]},{value:"Bruke JWT til autentisering og motta bearer-token",id:"bruke-jwt-til-autentisering-og-motta-bearer-token",children:[]},{value:"Legge ved token",id:"legge-ved-token",children:[]},{value:"Eksempel: Maskinporten som API",id:"eksempel-maskinporten-som-api",children:[]},{value:"Bruk",id:"bruk",children:[]},{value:"Bruksanvisning",id:"bruksanvisning",children:[]}]}],g={toc:p};function d(e){var t=e.components,o=(0,a.Z)(e,l);return(0,i.kt)("wrapper",(0,n.Z)({},g,o,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"backend-autentisering-med-jwts"},"Backend-autentisering med JWTs"),(0,i.kt)("p",null,"Hvordan du kan skjule JWT-autentisering i Gravitee, for eksempel for Maskinporten, uten at hver API-eier trenger f\xe5 tilgang til n\xf8kkelen."),(0,i.kt)("h2",{id:"bakgrunn"},"Bakgrunn"),(0,i.kt)("p",null,"Flere APIer hos andre institusjoner, bl.a. DF\xd8, krever autentisering med maskinporten. Andre API kan kreve autentisering med andre Authorization servers. Som oftest er det best om applikasjonen f\xe5r tilgang og autentiserer direkte mot Authorization serveren, men noen ganger kan de v\xe6re hensiktsmessig \xe5 autentisere api gateway mot api gateway"),(0,i.kt)("p",null,"DF\xd8 har satt opp APIene sine i maskinporten slik at man er n\xf8dt til \xe5 bruke virksomhetssertifikatet til autentisering. Med mange integrasjoner og andre applikasjoner som skal ha tilgang til disse APIene blir dette sertifikatet lagret mange steder om hver applikasjon skal autentisere selv. For \xe5 begrense antall stedet sertifikatet ligger blir denne autentiseringen utf\xf8rt i Gravitee."),(0,i.kt)("h3",{id:"lage-jwt-i-gravitee"},"Lage JWT i gravitee"),(0,i.kt)("p",null,'Bruk policy "Generate JWT" for \xe5 lage en JWT. Denne kan brukes videre, f.eks. i policy-en "Add header" eller "HTTP Callout".'),(0,i.kt)("p",null,"Generate JWT:"),(0,i.kt)("p",null,(0,i.kt)("a",{parentName:"p",href:"/docs/datadeling/veiledere/img/image-20200928103116-1.png"},(0,i.kt)("img",{src:r(4091).Z}))),(0,i.kt)("p",null,"Det er mange felt som m\xe5 fylles inn, hvilke som brukes er litt forskjellig i ulike authorizasjon servere Disse er verdt \xe5 merke seg:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},'Om sertifikatet er lagret p\xe5 filsystemet (ta kontakt med intark-drift for dette), velg "The content of the private key is provided by reading a PKCS12/JKS/PEM file from file system" under "Key resolver". Path til riktig mappe skrives inn i "Private key / Secret key / key store path". Hvis ikke velg "The content of the private key/secret is provided inline" og lim denne inn i "Private key / Secret key / key store path" lenger ned'),(0,i.kt)("li",{parentName:"ul"},"Passordet til private n\xf8kkelen blir vist i klartekst. V\xe6r n\xf8ye og begrens hvem som har tilgang til APIet"),(0,i.kt)("li",{parentName:"ul"},'Om du har lastet opp sertifikatet til Authorization serveren skriv inn IDen p\xe5 n\xf8kkelen i feltet kid. Hvis det er virksomhetsertifikat, ikke fyll inn feltet "kid", men velg "Add a certificate chain as axn X5C attribute" i "Certificate chain"'),(0,i.kt)("li",{parentName:"ul"},"Du kan legge p\xe5 s\xe5 mange ekstra Claims som du vil")),(0,i.kt)("h3",{id:"bruke-jwt-til-autentisering-og-motta-bearer-token"},"Bruke JWT til autentisering og motta bearer-token"),(0,i.kt)("p",null,"Gj\xf8res med HTTP Callout. Leg inn URL til autentiserings-endepunktet du skal bruke og evt. headere/parametre. Legg ved JWTen som akkurat ble laget vded \xe5 bruke Expression Language-notasjon: ${context.attributes","['jwt.generated']","}"),(0,i.kt)("p",null,"F.eks. for \xe5 bruke mo maskinporten m\xe5 du legge ved f\xf8lgende data: grant","_","type=urn%3Aietf%3Aparams%3Aoauth%3Agrant-type%3Ajwt-bearer&assertion=${context.attributes","['jwt.generated']","}"),(0,i.kt)("h3",{id:"legge-ved-token"},"Legge ved token"),(0,i.kt)("p",null,'For \xe5 legge p\xe5 bearer-token mottatt med HTTP Callaout-policyes: i "Transform Headers"-policy, klikk p\xe5 + under add, fyll inn Authorization som Name og som value: Bearer {#context.attributes',"['token']","}"),(0,i.kt)("h3",{id:"eksempel-maskinporten-som-api"},"Eksempel: Maskinporten som API"),(0,i.kt)("p",null,"I v\xe5r Gravitee har vi registrert maskinporten (p.t. versjon 2 test-l\xf8sningen) som et API."),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"APIet er ikke publisert"),(0,i.kt)("li",{parentName:"ul"},"Sikret med API n\xf8kkel og sperret til IP"),(0,i.kt)("li",{parentName:"ul"},"backend server endpoint er for test: ",(0,i.kt)("a",{parentName:"li",href:"https://ver2.maskinporten.no/token"},"https://ver2.maskinporten.no/token"))),(0,i.kt)("p",null,"Det er satt opp med f\xf8lgende policies:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"IP Filtering. NRECs ip-adresser er hvitelistet"),(0,i.kt)("li",{parentName:"ul"},"Cache. bruker parameteret scope som key og application som scope og 3599 (sekunder) som max varighet p\xe5 cachede objekter. Policyen henter svar fra cache kun n\xe5r http-metoden er GET."),(0,i.kt)("li",{parentName:"ul"},"Generate JWT - denne genererer JWT-fila som vi bruker for \xe5 autentisere mot maskinporten. iss (issuer) og scope hentes som parametre, resten av feltene er hardkodet"),(0,i.kt)("li",{parentName:"ul"},"assign content - legger p\xe5 requesten ihht. oauth2-standard og med JWT som akkurat er generert som assertion"),(0,i.kt)("li",{parentName:"ul"},"Transform parameters. Fjerner parameterne iss og scope"),(0,i.kt)("li",{parentName:"ul"},"Transform headers. legger til encoding"),(0,i.kt)("li",{parentName:"ul"},"Override HTTP method. Endrer til POST")),(0,i.kt)("p",null,"APIet er ogs\xe5 satt opp med en cache-ressurs."),(0,i.kt)("p",null,"I tilegg er applikasjonene registrert i samarbeidsportalen. Forel\xf8pig er det registrert 1 applikasjon med 4 scopes. ApplikasjonsIDen herfra er det som blir brukt som paramteret ",(0,i.kt)("em",{parentName:"p"},"iss")," (for Issuer). Dette er ogs\xe5 registrert hos DF\xd8."),(0,i.kt)("p",null,"Virksomhetsertifikatet\xa0 er opprettet som en secret i openshift-prsjektet og mountet som katalogen /certs p\xe5 b\xe5de api-manager og gateway-podene. P\xe5 denne m\xe5ten trenger vi kun registrere path til fila i api-et. Det er ikke n\xf8dvendig, man kan og lime inn base64-encoded virksomhetsertifikat rett in i policy-en."),(0,i.kt)("h3",{id:"bruk"},"Bruk"),(0,i.kt)("p",null,"API-ene som bruker dette for autentisering har 2 ekstra policies:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"HTTP Callout. Denne gj\xf8r en callout til maskinportenAPIet som er registrert hos oss med http metode GET og parametre for riktig scope og riktig issuer og headeren X-Gravitee-Api-Key for \xe5 f\xe5 tilgang."),(0,i.kt)("li",{parentName:"ul"},"Transform headers. Legger p\xe5 headeren Authorization med verdien 'Bearer' og jwt-tokenet som maskinporten returnerer.")),(0,i.kt)("p",null,"I tillegg er disse registrert som applikasjoner i API manager. Disse har f\xe5tt tilgang til maskinporten-APIet og api-n\xf8kkelen er registrert i HTTP callout-policy-en"),(0,i.kt)("h3",{id:"bruksanvisning"},"Bruksanvisning"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"For \xe5 registrere et API med maskinporten-autentisering m\xe5 den registreres som en applikasjon og be om tilgang til maskinporten PAIet. N\xe5r tilgangen er godkjent brukes API-n\xf8kkelen i http callout-policy-en"),(0,i.kt)("li",{parentName:"ul"},'P\xe5 siden for \xe5 administrere API-et, velg design (Palett-ikonet) og dra policy "HTTP Callout" til midten. Fyll inn',(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"scope: request"),(0,i.kt)("li",{parentName:"ul"},"HTTP Method: GET (Kan ogs\xe5 v\xe6re POST, da blir det generert nytt token hver gang. Det skap un\xf8dvenig belasning p\xe5 maskinporten og er tregt, men er kjekt ifm feils\xf8king)"),(0,i.kt)("li",{parentName:"ul"},"URL: ",(0,i.kt)("a",{parentName:"li",href:"https://gw-XXX.intark.uh-it.no/maskinporten-test/v2?iss=**%5C"},"https://gw-XXX.intark.uh-it.no/maskinporten-test/v2?iss=**\\"),"<ISSUER",">",(0,i.kt)("strong",{parentName:"li"},"&scope="),"\\<SCOPE",">","** (issuer finner du i samarbeidsportalen)"),(0,i.kt)("li",{parentName:"ul"},"Legg til Header X-Gravitee-Api-Key Verdien er API-n\xf8kkelen fra forrige punkt"),(0,i.kt)("li",{parentName:"ul"},"LEgg til Context variabel men navn Token og value {#jsonPath(#calloutResponse.content, '$.access","_","token')}"))),(0,i.kt)("li",{parentName:"ul"},"Dra s\xe5 policy Transform Header inn i midten. Under Add/update headers, leg til en med navn Authorization og verdi Bearer {#context.attributes","['token']","}")))}d.isMDXComponent=!0},4091:function(e,t,r){t.Z=r.p+"assets/images/image-20200928103116-1-02705284548bf65f9a86dce0e4a779f4.png"}}]);