"use strict";(self.webpackChunkprod=self.webpackChunkprod||[]).push([[6818],{3905:function(e,t,n){n.d(t,{Zo:function(){return k},kt:function(){return u}});var r=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},i=Object.keys(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var s=r.createContext({}),p=function(e){var t=r.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},k=function(e){var t=p(e.components);return r.createElement(s.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},d=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,i=e.originalType,s=e.parentName,k=l(e,["components","mdxType","originalType","parentName"]),d=p(n),u=a,f=d["".concat(s,".").concat(u)]||d[u]||m[u]||i;return n?r.createElement(f,o(o({ref:t},k),{},{components:n})):r.createElement(f,o({ref:t},k))}));function u(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var i=n.length,o=new Array(i);o[0]=d;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:a,o[1]=l;for(var p=2;p<i;p++)o[p]=n[p];return r.createElement.apply(null,o)}return r.createElement.apply(null,n)}d.displayName="MDXCreateElement"},2002:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return l},contentTitle:function(){return s},metadata:function(){return p},toc:function(){return k},default:function(){return d}});var r=n(7462),a=n(3366),i=(n(7294),n(3905)),o=["components"],l={description:"Tekniske detaljer om bruk og oppsett av meldingsk\xf8.\n\n\nTODO: Oppdater dette med Brom sine detaljer, og skriv om fr\xe5 UiO til bruk for UH-sektoren.",title:"Bruk av meldingsk\xf8"},s="Bruk av meldingsk\xf8",p={unversionedId:"datadeling/teknisk-plattform/mq-oppsett",id:"datadeling/teknisk-plattform/mq-oppsett",isDocsHomePage:!1,title:"Bruk av meldingsk\xf8",description:"Tekniske detaljer om bruk og oppsett av meldingsk\xf8.\n\n\nTODO: Oppdater dette med Brom sine detaljer, og skriv om fr\xe5 UiO til bruk for UH-sektoren.",source:"@site/docs/datadeling/teknisk-plattform/mq-oppsett.md",sourceDirName:"datadeling/teknisk-plattform",slug:"/datadeling/teknisk-plattform/mq-oppsett",permalink:"/datadeling-docs-tmp/docs/datadeling/teknisk-plattform/mq-oppsett",editUrl:"https://github.com/jokim/datadelingsdokumentasjon/tree/master/docs/datadeling/teknisk-plattform/mq-oppsett.md",version:"current",frontMatter:{description:"Tekniske detaljer om bruk og oppsett av meldingsk\xf8.\n\n\nTODO: Oppdater dette med Brom sine detaljer, og skriv om fr\xe5 UiO til bruk for UH-sektoren.",title:"Bruk av meldingsk\xf8"},sidebar:"tutorialSidebar",previous:{title:"F\xf8ringer for bruk av teknisk plattform i UH:IntArk",permalink:"/datadeling-docs-tmp/docs/datadeling/teknisk-plattform/krav"},next:{title:"Oversikt over den tekniske plattformen",permalink:"/datadeling-docs-tmp/docs/datadeling/teknisk-plattform/oversikt"}},k=[{value:"Hurtigstart",id:"hurtigstart",children:[]},{value:"Kj\xf8reregler",id:"kj\xf8reregler",children:[{value:"Vhosts",id:"vhosts",children:[]},{value:"Brukere",id:"brukere",children:[]},{value:"Exchange",id:"exchange",children:[]},{value:"K\xf8",id:"k\xf8",children:[]},{value:"Binding",id:"binding",children:[]},{value:"Topic",id:"topic",children:[]}]},{value:"Notifikasjoner",id:"notifikasjoner",children:[]},{value:"Mer info",id:"mer-info",children:[]}],m={toc:k};function d(e){var t=e.components,l=(0,a.Z)(e,o);return(0,i.kt)("wrapper",(0,r.Z)({},m,l,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"bruk-av-meldingsk\xf8"},"Bruk av meldingsk\xf8"),(0,i.kt)("p",null,"Tekniske detaljer om bruk og oppsett av meldingsk\xf8."),(0,i.kt)("p",null,"TODO: Oppdater dette med Brom sine detaljer, og skriv om fr\xe5 UiO til bruk for UH-sektoren."),(0,i.kt)("h2",{id:"hurtigstart"},"Hurtigstart"),(0,i.kt)("p",null,"For de ut\xe5lmodige:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Logg p\xe5 ",(0,i.kt)("a",{parentName:"li",href:"/docs/datadeling/teknisk-plattform/brom"},"Selvbetjeningsportalen for RabbitMQ"),", b\xe5de om du skal registrere en tilbyder, eller be om tilgang. Se ",(0,i.kt)("a",{parentName:"li",href:"/docs/datadeling/teknisk-plattform/oversikt"},"instans-oversikten for lenker hos din institusjons"),"."),(0,i.kt)("li",{parentName:"ol"},"Hent ut tilkoblingsdetaljer til RabbitMQ fr\xe5 selvbetjeningsportalen.",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"Anbefalt meldingsprotokoll: ",(0,i.kt)("a",{parentName:"li",href:"http://www.amqp.org/specification/0-9-1/amqp-org-download"},"AMQP 0.9.1")," p\xe5 port 5671 (TLS)")))),(0,i.kt)("p",null,"Se ",(0,i.kt)("a",{parentName:"p",href:"/docs/datadeling/kode/"},"kode-eksempler"),":"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Hvordan sende notifikasjoner (datatilbyder):  ",(0,i.kt)("a",{target:"_blank",href:n(5333).Z},"publisering_simpel.py")),(0,i.kt)("li",{parentName:"ul"},"Hvordan motta notifikasjoner (konsument): ",(0,i.kt)("a",{target:"_blank",href:n(5215).Z},"konsument_simpel.py"))),(0,i.kt)("h2",{id:"kj\xf8reregler"},"Kj\xf8reregler"),(0,i.kt)("p",null,"Videre f\xe5r du info om hvordan vi bruker ",(0,i.kt)("a",{parentName:"p",href:"http://www.amqp.org/specification/0-9-1/amqp-org-download"},"AMQP 0.9.1")," i IntArk. Se ",(0,i.kt)("a",{parentName:"p",href:"http://www.rabbitmq.com/tutorials/amqp-concepts.html"},"RabbitMQ sin beskrivelse av begrepene")," for mer utdypende informasjon."),(0,i.kt)("h3",{id:"vhosts"},"Vhosts"),(0,i.kt)("p",null,"En ",(0,i.kt)("em",{parentName:"p"},"virtuell host,")," eller ",(0,i.kt)("em",{parentName:"p"},"vhost"),", er RabbitMQ sin m\xe5te \xe5 skille prosjekt eller tjenester fra hverandre. Alle entiteter - k\xf8, binding og exchange - vil ligge i ",(0,i.kt)("em",{parentName:"p"},"\xe9n")," ",(0,i.kt)("em",{parentName:"p"},"vhost"),"."),(0,i.kt)("p",null,"Formatet til ",(0,i.kt)("em",{parentName:"p"},"vhosts")," likner p\xe5 en filstruktur:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"\n/no/\\<HOST\\>/\\<PROSJEKT\\>/[TEST|STAGING|PILOT]\n")),(0,i.kt)("p",null,"For UiO, for eksempel, bruker vi prim\xe6rt bare en ",(0,i.kt)("em",{parentName:"p"},"vhost"),":"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"\n/no/uio/integration\n\n")),(0,i.kt)("p",null,"Testing, staging og annet skiller vi ut i egne ",(0,i.kt)("em",{parentName:"p"},"vhosts, for eksempel:")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"\n/no/uio/integration/test\n\n")),(0,i.kt)("h3",{id:"brukere"},"Brukere"),(0,i.kt)("p",null,"For \xe5 lese og skrive til meldingsk\xf8en, trenger du en ",(0,i.kt)("em",{parentName:"p"},"brukrr")," i meldingsk\xf8en med de rette tilgangene. Vi skiller mellom brukere for avsendere (",(0,i.kt)("em",{parentName:"p"},"publishers"),") og mottakere (",(0,i.kt)("em",{parentName:"p"},"consumers"),"). Avsendere skal ikke ha tilgang til k\xf8er, og mottakere skal ikke kunne skrive til ",(0,i.kt)("em",{parentName:"p"},"exchange-"),"entiteter. Mottakere har tilgang til \xe5 opprette k\xf8er og knytte dem til ",(0,i.kt)("em",{parentName:"p"},"exchange-"),"entiteter."),(0,i.kt)("h3",{id:"exchange"},"Exchange"),(0,i.kt)("p",null,"En ",(0,i.kt)("em",{parentName:"p"},"exchange"),' er et "postkontor" som en avsender sender notifikasjoner til. Notifikasjonene distribuerest (router) videre derfra, til de forskjellige ',(0,i.kt)("em",{parentName:"p"},"k\xf8ene")," som vil ha den relevante notifikasjonen."),(0,i.kt)("p",null,"P\xe5 UiO bruker vi prim\xe6rt bare ",(0,i.kt)("em",{parentName:"p"},"en"),' exchange, "',(0,i.kt)("em",{parentName:"p"},"ex","_",'messages"'),", for ",(0,i.kt)("strong",{parentName:"p"},"alle")," avsendere. Denne ruter notifikasjonar med metoden ",(0,i.kt)("strong",{parentName:"p"},(0,i.kt)("em",{parentName:"strong"},"Topic Exchange")),"."),(0,i.kt)("h3",{id:"k\xf8"},"K\xf8"),(0,i.kt)("p",null,"En k\xf8 (",(0,i.kt)("em",{parentName:"p"},"queue)")," er ",(0,i.kt)("em",{parentName:"p"},"\xe9n")," konsument sin samling av notifikasjoner, eller hvilke typer notifikasjonar den vil ha (se ",(0,i.kt)("em",{parentName:"p"},"Binding"),").  ",(0,i.kt)("em",{parentName:"p"},"RabbitMQ")," videredistribuerer (router) de notifikasjonene k\xf8en vil ha. Konsumenten abonnerer da p\xe5 denne k\xf8en."),(0,i.kt)("p",null,'Navnet til k\xf8ene starter p\xe5 "',(0,i.kt)("em",{parentName:"p"},"q","_",'"'),', og b\xf8r inneholde navnet p\xe5 mottakeren eller tjenesten som bruker den. For eksempel "',(0,i.kt)("em",{parentName:"p"},"q","_","ad","_",'microservice"'),' eller "q',"_",'cerebrum".'),(0,i.kt)("h3",{id:"binding"},"Binding"),(0,i.kt)("p",null,"Hver k\xf8 settes opp med hvilke typer notifikasjoner den vil ha - k\xf8en m\xe5 v\xe6re bundet (bound) til en ",(0,i.kt)("em",{parentName:"p"},"exchange")," med en eller flere n\xf8kler. For ",(0,i.kt)("em",{parentName:"p"},"topic exchange"),', som "',(0,i.kt)("em",{parentName:"p"},"ex","_",'messages"')," er, g\xe5r knytningen mot ",(0,i.kt)("em",{parentName:"p"},"topic.")),(0,i.kt)("p",null,"Administratorbrukeren i RabbitMQ setter opp dette for forh\xe5ndsdefinerte k\xf8er, rett etter at k\xf8en er opprettet. Mottaker kan ogs\xe5 selv definere k\xf8en, men m\xe5 da ha lesetilgang til ",(0,i.kt)("em",{parentName:"p"},"ex","_","messages")," og skrivetilgang til k\xf8en den vil binde."),(0,i.kt)("p",null,"For eksempel kan k\xf8en ",(0,i.kt)("em",{parentName:"p"},"q","_","ad","_","microservice")," binde seg til ",(0,i.kt)("em",{parentName:"p"},"ex","_","messages"),' med n\xf8kkelen "',(0,i.kt)("em",{parentName:"p"},"cerebrum.event.account."),'"',(0,i.kt)("em",{parentName:"p"},". Dette gj\xf8r at alle notifikasjoner med topic som starter med "),'"cerebrum.event.account."',(0,i.kt)("em",{parentName:"p"}," vil dukke opp i "),"q","_","ad","_","microservice*."),(0,i.kt)("h3",{id:"topic"},"Topic"),(0,i.kt)("p",null,"N\xe5r ",(0,i.kt)("em",{parentName:"p"},"topic exchange")," brukaes for \xe5 distribuere (route) notifikasjoner fra ",(0,i.kt)("em",{parentName:"p"},"exchange")," til riktig k\xf8",(0,i.kt)("em",{parentName:"p"},",")," m\xe5 avsender markere hver notifikasjon med en ",(0,i.kt)("em",{parentName:"p"},"message routing key (topic)"),". RabbitMQ vil se p\xe5 ",(0,i.kt)("em",{parentName:"p"},"topic")," og videresende (",(0,i.kt)("em",{parentName:"p"},"route"),") notifikasjonen til de k\xf8ene som har binding mot samme ",(0,i.kt)("em",{parentName:"p"},"topic.")),(0,i.kt)("p",null,"Strukturen til ",(0,i.kt)("em",{parentName:"p"},"message routing key (topic)"),":"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"\n`kilde`.`type`.`objekt`.`hendelse`\n\n")),(0,i.kt)("p",null,"der:"),(0,i.kt)("p",null,'| kilde: | Navnet til avsenderen, for eksempel "cerebrum" |\n| type: | Typen melding, for eksempel "event" |\n| objekt: | Vanligvis hva entitetstype notifikasjonen/hendelsen gjelder for, for eksempel "account", "person", "group" eller "employee" |\n| hendelse: | Hva har skjedd, for eksempel "add", "delete" eller "modify" |'),(0,i.kt)("h2",{id:"notifikasjoner"},"Notifikasjoner"),(0,i.kt)("p",null,"hva finner du av innhold i notifikasjonene? Etter UiO sin integrasjonsarkitektur skal notifikasjoner v\xe6re ",(0,i.kt)("strong",{parentName:"p"},"tynne"),", som betyr at de skal prim\xe6rt brukes til \xe5 informere om at ",(0,i.kt)("strong",{parentName:"p"},"noe")," har skjedd, for en gitt entitet, men forteller deg ",(0,i.kt)("strong",{parentName:"p"},"ikke")," mer om entiteten. Dette m\xe5 du f\xe5 ved \xe5 sp\xf8rre kildesystemet."),(0,i.kt)("p",null,"Det er opp til hver tjeneste \xe5 definere formatet p\xe5 notifikasjonene sine. Dette skal vere dokumentert hos hvert API, p\xe5 ",(0,i.kt)("a",{parentName:"p",href:"https://api.uio.no"},"api.uio.no"),"."),(0,i.kt)("p",null,"For eksempel bruker Cerebrum og SAPUiO et notifikasjonsformat som er inspirert av ",(0,i.kt)("a",{parentName:"p",href:"http://www.simplecloud.info/"},"SCIM")," sitt ",(0,i.kt)("a",{parentName:"p",href:"https://tools.ietf.org/html/draft-hunt-idevent-scim-00"},"utkast til standard p\xe5 et meldingsformat"),", der vi bruker versjonen med minimalt med informasjon. Et eksempel p\xe5 hvordan ei melding vil se ut, ",(0,i.kt)("strong",{parentName:"p"},"omtrent"),":"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'\n{\n  // token identifier (unik id for meldingen)\n  "jti": "4d3559ec67504aaba65d40b0363faad8",\n  // endringer\n  "eventUris": [\n    "urn:ietf:params:event:SCIM:create"\n  ],\n  // timestamp\n  "iat": 1458496404,\n  // issuer\n  "iss": "https://cerebrum-uio.uio.no",\n  // audience (spreads/kontekst) - gj\xf8r det enklere \xe5 forkaste meldinger du ikke er interessert i\n  "aud": [\n   "AD\\_account",\n   "exchange\\_acc@uio.no",\n   "LDAP\\_account"\n  ],\n  // URL til entitet (GET)\n **"sub": "https://cerebrum-ws.uio.no/v1/accounts/1234",**\n  // Parametre til event - her: hvilke attributter hos objektet som er p\xe5viret - gj\xf8r det enklere \xe5 forkaste meldinger du ikke er interessert i\n  "urn:ietf:params:event:SCIM:create":{\n    "attributes":["id","name","userName","password","emails"],\n  }\n}\n\n')),(0,i.kt)("p",null,"Andre system, som FS og TP, bruker et format som er avledet fra ",(0,i.kt)("a",{parentName:"p",href:"https://jwt.io"},"JWT"),"-standarden. Et eksempel p\xe5 en notifikasjon fra FS om at en person er oppdatert (routing key er i dette tilfelle ",(0,i.kt)("em",{parentName:"p"},"no.uio.fs.FS-prod.personer.update"),")"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'\n{"sub": "personer/56154",\n "iss": "FS-prod",\n "iat": "1582344412462",\n "operation": "update",\n "jti": "35380ac0-247d-44b3-9be3-2f2dded049ee",\n "person\\_id": "56154"}\n')),(0,i.kt)("p",null,"Det kan og v\xe6re lurt \xe5 ta en avgj\xf8relse om hvordan du skal referere til ressurser i kildesystem. For eksempel er vi bundet til et spesielt domene i dette tilfellet:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'\n{"sub": "https://api-waygate.uio.no/eksempeltjeneste/5"}\n')),(0,i.kt)("p",null,"Mens f\xf8lgende ikke er bundet til en spesifikk maskin:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'\n{"sub": "/5",\n "iss": "eksempeltjeneste"}\n\n')),(0,i.kt)("p",null,"Det smame kan du oppn\xe5 med en mer formalisert URN:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'\n{"sub": "urn:eksempeltjeneste:5"}\n')),(0,i.kt)("p",null,"I de to siste eksemplene har vi ikke inkludert informasjon om ",(0,i.kt)("em",{parentName:"p"},"hvor")," en ressurs er lokalisert. N\xe5r du henter ressursen m\xe5 du da velge \xe5 sl\xe5 opp maskinnavnet. Erfaringsmessig letter dette arbeidet med \xe5 flytte tjenester mellom forskjellige milj\xf8."),(0,i.kt)("p",null,"For nyutviklede system, b\xf8r du vurdere \xe5 bruke standariserte format, for eksempel ",(0,i.kt)("a",{parentName:"p",href:"https://cloudevents.io/"},"CloudEvents"),"."),(0,i.kt)("h2",{id:"mer-info"},"Mer info"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"http://www.rabbitmq.com/"},"RabbitMQ sin offisielle side")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"http://www.rabbitmq.com/getstarted.html"},"Tutorials og kodeeksempler fr\xe5 RabbitMQ")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"http://www.rabbitmq.com/tutorials/amqp-concepts.html"},"RabbitMQ sin beskrivelse av begrepene i AMQP")),(0,i.kt)("li",{parentName:"ul"},"Beskrivelse av meldingsprotokollen ",(0,i.kt)("a",{parentName:"li",href:"http://www.amqp.org/specification/0-9-1/amqp-org-download"},"AMQP 0.9.1")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://tools.ietf.org/html/draft-hunt-idevent-scim-00"},"Meldingsformatet til SCIM"),", som er utgangspunktet for mange av meldingene, som igjen baserer seg p\xe5 ",(0,i.kt)("a",{parentName:"li",href:"https://jwt.io/"},"JWT")," (",(0,i.kt)("a",{parentName:"li",href:"https://tools.ietf.org/html/rfc7519"},"RFC 7519"),")")))}d.isMDXComponent=!0},5215:function(e,t,n){t.Z=n.p+"assets/files/konsument_simpel-33ff4a78aeb8375333523069ffb741bb.py"},5333:function(e,t,n){t.Z=n.p+"assets/files/publisering_simpel-ddafea0fb4b995e8f9e7789734651964.py"}}]);